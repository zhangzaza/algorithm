# aboutHash

本章并无code，因为资源限制类题目输入需要的条件较多并且真的实现代码量巨大

面试中这类题目出现也就和面试官聊解法，不会有代码实现的要求



## 1.哈希函数

### 1.1.哈希函数特点

「Code01_1」

1. 输入域无限「♾️」，输出域有限「0～2^64-1」，所以肯定有不同的输入对应相同的输出，所以这个就叫哈希碰撞
2. 哈希函数不会有随机的成分，相同的输入一定导致导致相同的输出
3. **最重要**：不同的输入会离散到整个数据结构上，比如数据存储在一条线段上，你拿一条短的线段，随机放在原线段上，包含的存储的都是几乎等量的「**离散性，等量性**」



### 1.2.时间复杂度

1. 扩容的时间复杂度为 O(1) 「Code01_2」
2. 如果数组对应的桶都是链表，每次添加的时间复杂度为O(1),如果工程上进行修改，所以就是优化，时间复杂度还是O(1)



## 2.Bloom Filter 

### 2.1.假阳性☑️，假阴性✖️

1. **假阳性（False Positive）**：
   - 当布隆过滤器声称一个元素在集合中时，这个元素可能实际上并不在集合中。这就是所谓的假阳性。
   - 由于布隆过滤器的结构和设计，它有可能将多个不同元素的哈希结果映射到相同的位上，从而导致一个元素被错误地识别为存在。
2. **假阴性（False Negative）**：
   - 当布隆过滤器声称一个元素不在集合中时，这个元素确实不在。这就是说，布隆过滤器不会给出假阴性。
   - 布隆过滤器的设计确保，当一个元素未被插入时，必然会有至少一个对应位为0。因此，如果任何一个位为0，元素一定不存在。

### 2.2.实际应用中的意义

- **快速判断不存在**：
  - 在应用中，布隆过滤器特别适合用于快速判断一个元素是否不在集合中。如果布隆过滤器说元素不在，就可以确信地认为元素不在，从而避免进一步的资源消耗（如磁盘访问或网络请求）。
- **容忍误判的场景**：
  - 在某些应用中，布隆过滤器的假阳性是可以接受的，因为即使检测到元素存在但实际上不存在，后续的处理（比如访问数据库）也可以纠正这个误判。



### 2.3.原理实现

看「code02_4」

>### Bit（比特）
>
>- **定义**：比特（bit）是计算机中最小的数据单位。它可以表示两种状态之一：0 或 1。
>- **作用**：比特是信息存储和处理的基本单位。所有数字信息最终都以比特的形式存储和处理。
>
>### Byte（字节）
>
>- **定义**：字节（byte）是由 8 个连续的比特组成的单位。字节是计算机中最常用的数据单位。
>- **作用**：字节用于表示较大的数据范围，例如一个字符（在 ASCII 编码中，一个字节可以表示一个字符）。
>
>### 关系
>
>- 1 Byte = 8 Bits

### 2.4.指标相关

但是需要知道 bits数组 m的长度，和使用几个哈希函数？「code02_5」

- m**数组和哪几个元素有关**？****
  - 样本量「100亿」
  - 失误率「0.01%」
  - 单样本大小
- 最后需要 m 和 k
  - m为bit数组
  - k为哈希函数

>布隆过滤器的设计涉及三个关键参数：数据量 \( n \)（即插入的元素数量）、失误率 \( p \)（即允许的假阳性概率）和需要的内存 \( m \)（即位数组的大小，通常用位表示）。这些参数之间的关系可以通过以下公式计算：
>
>### 计算公式
>
>1. **位数组大小 \( m \) 的计算**：
>
>   \[
>   m = -\frac{n \cdot \ln p}{(\ln 2)^2}
>   \]
>
>   - \( n \) 是要插入的元素数量。
>   - \( p \) 是期望的假阳性率。
>   - \( \ln \) 是自然对数。
>
>2. **最优哈希函数数量 \( k \) 的计算**：
>
>   \[
>   k = \frac{m}{n} \cdot \ln 2
>   \]
>
>   - \( m \) 是位数组的大小。
>   - \( n \) 是要插入的元素数量。
>
>### 理解这些公式
>
>- **位数组大小 \( m \) 的公式**说明，为了达到目标假阳性率 \( p \)，所需的位数组大小与元素数量 \( n \) 和假阳性率 \( p \) 有关。更小的假阳性率 \( p \) 需要更大的位数组。
>
>- **哈希函数数量 \( k \) 的公式**说明了在给定的位数组大小和元素数量下，多少个哈希函数可以最优化假阳性率。通常，哈希函数数量 \( k \) 是整数，且通过上述公式计算后四舍五入得到。
>
>### 示例
>
>假设我们希望在布隆过滤器中插入 1000 个元素，目标假阳性率是 1%（即 0.01）。我们可以计算：
>
>1. **计算位数组大小 \( m \)**：
>   \[
>   m = -\frac{1000 \cdot \ln 0.01}{(\ln 2)^2} \approx 9586 \text{ bits}
>   \]
>
>2. **计算最优哈希函数数量 \( k \)**：
>   \[
>   k = \frac{9586}{1000} \cdot \ln 2 \approx 6.64 \approx 7 \text{（取整数）}
>   \]
>
>通过这两个公式，我们能够合理地设计布隆过滤器以满足特定的需求和约束条件。



### 2.5.应用：HDFS

「code02_7」





## 3.一致性哈希 

分布式存储结构最常见的结构

1. 哈希域变成环的设计
2. 虚拟节点技术	

>一致性哈希（Consistent Hashing）是一种用于分布式系统中的哈希算法，旨在通过将请求均匀分布到多个节点上来实现负载均衡，并且在节点数量变化时保持系统的平稳性。
>
>### 核心概念
>
>1. **哈希环（Hash Ring）**：
>   - 一致性哈希将整个哈希空间组织成一个环，哈希值的范围从 0 到 232−1232−1（或其他范围，取决于哈希函数的位数）。
>   - 每个节点使用哈希函数来计算其位置，并在环上按顺时针方向排列。
>2. **数据映射**：
>   - 数据项同样通过哈希函数计算其位置，并映射到环上。
>   - 数据项被存储在顺时针方向遇到的第一个节点上。



### 3.1.**哈希环（Hash Ring）**

1. 物理机在环上冲突的概率技术为 0 ，因为是小样本量
2. 就算重了，你直接换一个ip就可以



### 3.2.节点的加入和离开

- 当一个节点加入或离开时，仅需重新分配附近的一小部分数据，而非所有数据。这使得一致性哈希对节点动态变化具有很好的适应性。
- 例如，当一个新节点加入时，它只需取代环上部分数据项的负责节点；同样地，当一个节点离开时，其数据项由下一个节点接管。



### 3.3.服务器数据分配不均的问题

使用虚拟节点技术



### 3.4.加入机器的时候如何实现数据分配不均的问题

使用虚拟节点技术



### 3.5.虚拟节点技术

>一致性哈希中的虚拟节点技术是用来解决哈希环上节点分布不均带来的数据不平衡问题的一种方法。在一致性哈希中，实际节点（物理节点）可能会因为其哈希值分布不均而导致负载不均衡。虚拟节点技术通过在哈希环上为每个物理节点映射多个虚拟节点来改善这一问题。
>
>### 虚拟节点的工作原理
>
>1. **映射多个虚拟节点**：
>   - 每个物理节点通过不同的哈希函数或不同的种子值生成多个哈希值，从而在哈希环上创建多个虚拟节点。
>   - 虚拟节点在哈希环上均匀分布，从而使每个物理节点的负载更加均衡。
>
>2. **数据项映射到虚拟节点**：
>   - 数据项首先通过哈希函数计算出其哈希值。
>   - 然后，它们被映射到哈希环上顺时针方向遇到的第一个虚拟节点。
>   - 虚拟节点负责将数据导向其对应的物理节点。
>
>3. **平衡负载**：
>   - 通过增加虚拟节点，哈希环上每个物理节点被分配到的范围更可能接近平均，从而减少负载不均衡的发生。
>   - 当一个节点加入或离开时，由于存在多个虚拟节点，重新分配的数据量也相对更小。
>
>### 优势
>
>- **更均匀的分布**：虚拟节点使得每个物理节点的负载更加均匀地分布在整个哈希空间中。
>- **灵活的扩展**：当集群中添加或移除物理节点时，虚拟节点技术可以减少每次变化对负载分布的影响。
>- **易于实现**：增加虚拟节点的实现相对简单，只需在配置或代码中添加对虚拟节点的支持。
>
>### 典型应用
>
>虚拟节点技术被广泛应用于分布式系统中，如分布式缓存系统（如 Memcached）、分布式数据库（如 Cassandra）等，以便在大量节点加入或离开时仍能保持较为平衡的负载分布。
>
>通过这种方式，一致性哈希不仅能够在节点动态变化时保持数据一致性和稳定性，还能通过较少的调整保持负载均衡。



### 3.6.物理机挂了怎么办？

#### 1. 数据复制

- **副本机制**：将数据复制到多个物理节点上，确保即使一个节点故障，数据也能从副本节点恢复。例如，像Hadoop HDFS、Cassandra等系统都使用数据复制来保证容错性。
- **同步复制和异步复制**：根据系统的需求，可以选择同步复制（确保数据在写入时立即复制到多个节点）或者异步复制（数据写入后稍后再复制）。

#### 2. 数据重平衡

- **一致性哈希重平衡**：在一致性哈希的环境下，当一个节点挂掉，该节点负责的数据会被自动重新分配给其他节点。这通常伴随着虚拟节点技术的使用，以确保负载的均衡性。
- **自动数据迁移**：某些系统会监控节点的健康状态，并在检测到节点故障时，自动将数据迁移到其他健康的节点。

